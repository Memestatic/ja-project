@page "/fir"
@using System.Diagnostics
@rendermode InteractiveServer
@inject IJSRuntime _js

<PageTitle>FIR</PageTitle>

<div class="card card-body m-5 w-50">
    <h1 class="mb-4">FIR Low Pass Filter</h1>

    <InputFile OnChange="HandleFileSelected" MaxFileSize="2097152" />

    <div class="mt-3">
        <h5>Select the number of threads:</h5>
        <div class="btn-group me-2 mt-2" role="group">
            <button type="button" class="btn btn-primary" @onclick="() => SetThreadCount(1)">1</button>
            <button type="button" class="btn btn-primary" @onclick="() => SetThreadCount(2)">2</button>
            <button type="button" class="btn btn-primary" @onclick="() => SetThreadCount(4)">4</button>
            <button type="button" class="btn btn-primary" @onclick="() => SetThreadCount(maxThreads)">@maxThreads</button>
        </div>
    </div>

    <button class="btn btn-success mt-3" @onclick="Start" disabled="@isFileNotSelected">Apply FIR Filter</button>
</div>

@if (!string.IsNullOrEmpty(audioSrc))
{
    <div class="card bg-light mt-5 p-3 w-75">
        <h4>Filtered Audio:</h4>
        <audio controls class="w-100">
            <source src="@audioSrc" type="audio/wav" />
            Your browser does not support the audio element.
        </audio>

        <p class="mt-3">
            Czas wykonania algorytmu: @timeResult ms
        </p>
    </div>
}

@code {
    double timeResult = 0;
    private IBrowserFile selectedFile;
    private bool isFileNotSelected = true;
    private string audioSrc; // Path to the filtered audio
    private int threadCount = 1; // Default number of threads
    private int maxThreads = Environment.ProcessorCount; // Maximum number of threads

    private WavFileProcessor wavFileProcessor = new WavFileProcessor();

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        Console.WriteLine("File selected");
        selectedFile = e.File;
        isFileNotSelected = selectedFile == null || selectedFile.ContentType != "audio/wav"; // Added file type check
        StateHasChanged();
    }

    private void SetThreadCount(int count)
    {
        threadCount = count;
        StateHasChanged();
    }

    private async Task Start()
    {
        if (selectedFile == null)
        {
            Console.WriteLine("No file selected.");
            return;
        }

        try
        {
            Stopwatch stopwatch = new();

            await wavFileProcessor.ConvertWavToFloatArray(selectedFile);

            float[] floatData = wavFileProcessor.FloatData;
            long totalSamples = floatData.Length;
            float[][] processedChunks = new float[totalSamples / threadCount][];
            List<Thread> threads = new List<Thread>();

            stopwatch.Start();

            for (int i = 0; i < threadCount; i++)
            {
                long start = i * (totalSamples / threadCount);
                long end = (i + 1) * (totalSamples / threadCount);
                int index = i;

                var thread = new Thread(() =>
                {
                    float[] chunk = new float[end - start];
                    Array.Copy(floatData, start, chunk, 0, end - start);
                    processedChunks[index] = ProcessFIRFilter(chunk);
                });

                threads.Add(thread);
                thread.Start();
            }

            foreach (var t in threads)
            {
                t.Join();
            }

            stopwatch.Stop();
            timeResult = stopwatch.Elapsed.TotalMilliseconds;

            float[] processedData = new float[totalSamples];
            for (int i = 0; i < threadCount; i++)
            {
                Array.Copy(processedChunks[i], 0, processedData, i * (totalSamples / threadCount), processedChunks[i].Length);
            }

            audioSrc = wavFileProcessor.ConvertFloatArrayToWav();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error processing file: {ex.Message}, {ex.StackTrace}");
        }
    }

    private float[] ProcessFIRFilter(float[] audioData)
    {
        // Placeholder for FIR filter algorithm
        return audioData; // Just returns the data as-is
    }
}